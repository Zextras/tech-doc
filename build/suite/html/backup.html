<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zextras Backup &mdash; Zextras Suite 0.1-alpha documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/design-style.d53ab927f7bad3eaa42da95908504b10.min.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/suite.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/design-tabs.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Zextras Mobile" href="mobile.html" />
    <link rel="prev" title="Zextras Suite Installation Guide" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #00506d" >
            <a href="index.html" class="icon icon-home"> Zextras Suite
            <img src="_static/zextras_white.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="general.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Zextras Suite Installation Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Zextras Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#zextras-backup-common-tasks">Zextras Backup Common Tasks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-to-activate-zextras-backup">How to Activate Zextras Backup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#architecture-of-zextras-backup">Architecture of Zextras Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#item">Item</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transaction">Transaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#smartscan-and-real-time-scan">SmartScan and Real Time Scan</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backup-path">Backup Path</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-the-backup-path">Setting the Backup Path</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#retention-policy">Retention Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backup-purge">Backup Purge</a></li>
<li class="toctree-l3"><a class="reference internal" href="#coherency-check">Coherency Check</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-zextras-backup-works">How Zextras Backup Works</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">Structure of an Item</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#backup-of-team-database">Backup of Team Database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id17">SmartScan</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-the-smartscan">What is the SmartScan?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-does-it-work">How Does it Work?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#when-is-a-smartscan-executed">When is a SmartScan Executed?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-a-smartscan">Running a SmartScan</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-scan-via-the-administration-zimlet">Starting the Scan via the Administration Zimlet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-smartscan-via-the-cli">Starting the SmartScan via the CLI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#checking-the-status-of-a-running-scan">Checking the Status of a Running Scan</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#real-time-scan">Real Time Scan</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-the-real-time-scanner">What is the Real Time Scanner?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-does-it-work-2">How Does it Work?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#managing-the-real-time-scanner">Managing the Real Time Scanner</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enabling-the-real-time-scanner">Enabling the Real Time Scanner</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disabling-the-real-time-scanner">Disabling the Real Time Scanner</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations-and-safety-scan">Limitations and Safety Scan</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#backup-purge-2">Backup Purge</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-the-backup-purge">What is the Backup Purge?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-does-it-work-3">How Does it Work?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#when-is-a-backup-purge-executed">When is a Backup Purge Executed?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-a-backup-purge">Running a Backup Purge</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-backup-purge-via-the-administration-zimlet">Starting the Backup Purge via the Administration Zimlet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-backup-purge-via-the-cli">Starting the Backup Purge via the CLI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#checking-the-status-of-a-running-backup-purge">Checking the Status of a Running Backup Purge</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#limitations-and-corner-cases-of-the-backup">Limitations and Corner Cases of the Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting-ldap-backup">Troubleshooting LDAP Backup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#increase-log-verbosity">Increase Log Verbosity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#missing-root-credentials">Missing root credentials</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disable-ldap-backup">Disable LDAP Backup</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#backup-on-external-storage">Backup on external storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#how-the-backup-on-external-storage-works">How the Backup on external storage works</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#goals-and-benefits">Goals and benefits</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-stored-in-the-external-storage">Data stored in the external storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-storages">External storages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#nfs-fuse-external-storage">NFS/Fuse external storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#s3-external-storage">S3 external storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#s3-backup-in-a-multi-mailbox-environment">S3 Backup in a multi-mailbox environment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#activate-backup-on-the-external-storage">Activate backup on the external storage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#zextras-backup-cli">Zextras Backup CLI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mobile.html">Zextras Mobile</a></li>
<li class="toctree-l1"><a class="reference internal" href="powerstore.html">Zextras Powerstore</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin.html">Zextras Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="drive.html">Zextras Drive</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs.html">Zextras Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="auth.html">Zextras Auth</a></li>
<li class="toctree-l1"><a class="reference internal" href="team.html">Zextras Team</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI</a></li>
</ul>

<hr />
<ul>
  <li class="toctree-l1">
    <a href="/landing/html/home.html">Back to
      Zextras Documentation hub
    </a>
  </li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #00506d" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Zextras Suite</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Zextras Backup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="admonition note">
<p class="admonition-title">Note</p>
<p>All content is provisional and is meant <strong>only</strong> to showcase
the feature of the new framework.</p>
</div>
<section id="zextras-backup">
<h1><a class="toc-backref" href="#id78">Zextras Backup</a><a class="headerlink" href="#zextras-backup" title="Permalink to this headline"></a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date</dt>
<dd class="field-odd"><p>2021-10-19</p>
</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#zextras-backup" id="id78">Zextras Backup</a></p>
<ul>
<li><p><a class="reference internal" href="#zextras-backup-common-tasks" id="id79">Zextras Backup Common Tasks</a></p>
<ul>
<li><p><a class="reference internal" href="#how-to-activate-zextras-backup" id="id80">How to Activate Zextras Backup</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#architecture-of-zextras-backup" id="id81">Architecture of Zextras Backup</a></p>
<ul>
<li><p><a class="reference internal" href="#item" id="id82">Item</a></p></li>
<li><p><a class="reference internal" href="#transaction" id="id83">Transaction</a></p></li>
<li><p><a class="reference internal" href="#smartscan-and-real-time-scan" id="id84">SmartScan and Real Time Scan</a></p></li>
<li><p><a class="reference internal" href="#backup-path" id="id85">Backup Path</a></p></li>
<li><p><a class="reference internal" href="#retention-policy" id="id86">Retention Policy</a></p></li>
<li><p><a class="reference internal" href="#backup-purge" id="id87">Backup Purge</a></p></li>
<li><p><a class="reference internal" href="#coherency-check" id="id88">Coherency Check</a></p></li>
<li><p><a class="reference internal" href="#how-zextras-backup-works" id="id89">How Zextras Backup Works</a></p></li>
<li><p><a class="reference internal" href="#backup-of-team-database" id="id90">Backup of Team Database</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id17" id="id91">SmartScan</a></p>
<ul>
<li><p><a class="reference internal" href="#what-is-the-smartscan" id="id92">What is the SmartScan?</a></p></li>
<li><p><a class="reference internal" href="#how-does-it-work" id="id93">How Does it Work?</a></p></li>
<li><p><a class="reference internal" href="#when-is-a-smartscan-executed" id="id94">When is a SmartScan Executed?</a></p></li>
<li><p><a class="reference internal" href="#running-a-smartscan" id="id95">Running a SmartScan</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#real-time-scan" id="id96">Real Time Scan</a></p>
<ul>
<li><p><a class="reference internal" href="#what-is-the-real-time-scanner" id="id97">What is the Real Time Scanner?</a></p></li>
<li><p><a class="reference internal" href="#how-does-it-work-2" id="id98">How Does it Work?</a></p></li>
<li><p><a class="reference internal" href="#managing-the-real-time-scanner" id="id99">Managing the Real Time Scanner</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#backup-purge-2" id="id100">Backup Purge</a></p>
<ul>
<li><p><a class="reference internal" href="#what-is-the-backup-purge" id="id101">What is the Backup Purge?</a></p></li>
<li><p><a class="reference internal" href="#how-does-it-work-3" id="id102">How Does it Work?</a></p></li>
<li><p><a class="reference internal" href="#when-is-a-backup-purge-executed" id="id103">When is a Backup Purge Executed?</a></p></li>
<li><p><a class="reference internal" href="#running-a-backup-purge" id="id104">Running a Backup Purge</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#limitations-and-corner-cases-of-the-backup" id="id105">Limitations and Corner Cases of the Backup</a></p>
<ul>
<li><p><a class="reference internal" href="#troubleshooting-ldap-backup" id="id106">Troubleshooting LDAP Backup</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#backup-on-external-storage" id="id107">Backup on external storage</a></p>
<ul>
<li><p><a class="reference internal" href="#how-the-backup-on-external-storage-works" id="id108">How the Backup on external storage works</a></p></li>
<li><p><a class="reference internal" href="#data-stored-in-the-external-storage" id="id109">Data stored in the external storage</a></p></li>
<li><p><a class="reference internal" href="#external-storages" id="id110">External storages</a></p></li>
<li><p><a class="reference internal" href="#activate-backup-on-the-external-storage" id="id111">Activate backup on the external storage</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#zextras-backup-cli" id="id112">Zextras Backup CLI</a></p></li>
</ul>
</li>
</ul>
</div>
<p>This chapter describes Zextras Backup, Zextras Suite’s component that is
responsible to back up all the data. The chapter is divided into several
sections: at the beginning, an overview of the most common task is given
along with pointers to more technical references.</p>
<p>Next, the architecture of Zextras Backup is described, which includes
also important concepts to know beforehand; the concepts will be
detailed in the remainder of the chapter.</p>
<p>Finally, the available options to periodically store and check the data
backed up are presented. All sections are accompanied with the
corresponding Command Line Reference.</p>
<blockquote>
<div><p><strong>Important</strong></p>
<p><a class="reference external" href="restorestrategies.xml#backup-restore-strategies">Restore
Strategies</a> for
the Backup and <a class="reference external" href="advancedbackup.xml#backup-advanced-techniques">Advanced Backup
Techniques</a>,
including Disaster Recovery, have now a dedicated chapter.</p>
</div></blockquote>
<blockquote>
<div><p><strong>Community Article:</strong></p>
<p><a class="reference external" href="https://community.zextras.com/zimbra-migration-with-zextras-backup/">https://community.zextras.com/zimbra-migration-with-zextras-backup/</a></p>
<p>A detailed, step-by-step guide to migrate Zimbra domains, accounts
and emails using Zextras Backup.</p>
</div></blockquote>
<section id="zextras-backup-common-tasks">
<span id="id1"></span><h2><a class="toc-backref" href="#id79">Zextras Backup Common Tasks</a><a class="headerlink" href="#zextras-backup-common-tasks" title="Permalink to this headline"></a></h2>
<p>This section contains guidelines for the most common task required by
the users; also links to technical resources are also provided.</p>
<section id="how-to-activate-zextras-backup">
<span id="init-zextras-backup"></span><h3><a class="toc-backref" href="#id80">How to Activate Zextras Backup</a><a class="headerlink" href="#how-to-activate-zextras-backup" title="Permalink to this headline"></a></h3>
<p>Once you have finished your servers setup, you need a few more steps to
configure the Backup module and have all your data automatically backed
up.</p>
<ul class="simple">
<li><p>Mount a storage device at your target location. We use the default
<code class="docutils literal notranslate"><span class="pre">/opt/zimbra/backup/zextras</span></code> throughout this section; remember to
replace it with the path you chose.</p></li>
</ul>
<blockquote>
<div><p><strong>Important</strong></p>
<p>The size of the device should be at least 80% of primary + secondary
volume size.</p>
</div></blockquote>
<ul class="simple">
<li><p>Set the correct permission on the backup path: <code class="docutils literal notranslate"><span class="pre">chown</span> <span class="pre">zimbra:zimbra</span>
<span class="pre">/opt/zimbra/backup/zextras</span></code></p></li>
</ul>
<figure class="align-default" id="id76">
<img alt="Zextras Backup Admin Console" src="_images/backup-ui.png" />
<figcaption>
<p><span class="caption-text">Zextras Backup Admin Console</span><a class="headerlink" href="#id76" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>You can optionally customise some of the Zextras Backup options shown in
Figure <a class="reference external" href="#img-backup-console">figure_title</a>, for example:</p>
<ul class="simple">
<li><p>Change the backup path. You can modify the full path for backups
either from the admin console (see screenshot of Figure
<a class="reference external" href="#img-backup-console">figure_title</a>), or from the command line,
for example:</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">zxsuite config server set $(zmhostname) attribute ZxBackup_DestPath value /opt/zimbra-backup</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Backup Zimbra customisations. With this option, configuration and
other changes made to Zimbra are saved in a separate file named
<code class="docutils literal notranslate"><span class="pre">customizations_dd_mm_yyy#xx_xx.tar.gz</span></code>. Here, <code class="docutils literal notranslate"><span class="pre">dd_mm_yyy</span></code>
represents the date when the backup was created, while <code class="docutils literal notranslate"><span class="pre">xx_xx</span></code> is
an identifier. The archive contains the full configuration of zimbra:
crontab, nginx webserver, postfix and antivirus, LDAP connection,
Zimbra templates, and more.</p></li>
<li><p>Enable the <a href="#id113"><span class="problematic" id="id114">`Real Time
Scan &lt;./architecture.xml#&lt;emphasis&gt;smartscan_and_real_time_scan&gt;`_</span></a>,
by clicking the Enable button in the _RealTime Scanner&lt;/emphasis&gt;
box</p></li>
<li><p>Once you have specified the backup path, it must be initialised, an
operation that can be done either from the admin console or the
command line. In the first case, click on the Initialize NOW! button
on the top right corner of Figure
<a class="reference external" href="#img-backup-console">figure_title</a> screenshot. From the CLI,
initialization is done by simply starting
<a class="reference external" href="./cli.xml#backup_doSmartScan">SmartScan</a> for the first time:
<code class="docutils literal notranslate"><span class="pre">zxsuite</span> <span class="pre">backup</span> <span class="pre">doSmartScan</span> <span class="pre">start</span></code></p></li>
</ul>
<blockquote>
<div><p><strong>Tip</strong></p>
<p>To avoid a flood of notifications about running operations, it is
suggested to lower the default <em>Notification level</em> from
<strong>Information</strong> to one of <strong>Warning</strong>, <strong>Error</strong>, or <strong>Critical</strong>
(see Figure <a class="reference external" href="#img-backup-notification">figure_title</a>).</p>
</div></blockquote>
<figure class="align-default" id="id77">
<img alt="Zextras Backup Notification Level" src="_images/backup-notification-level.png" />
<figcaption>
<p><span class="caption-text">Zextras Backup Notification Level</span><a class="headerlink" href="#id77" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="architecture-of-zextras-backup">
<span id="backup-architecture"></span><h2><a class="toc-backref" href="#id81">Architecture of Zextras Backup</a><a class="headerlink" href="#architecture-of-zextras-backup" title="Permalink to this headline"></a></h2>
<p>This section introduces the main concepts needed to understand the
architecture of Zextras Backup and outlines their interaction; each
concept is then detailed in a dedicated section.</p>
<p>Before entering in the architecture of Zextras Backup, we recall two
general approaches that are taken into account when defining a backup
strategy: <strong>RPO</strong> and <strong>RTO</strong>.</p>
<p>The Recovery Point Objective (<strong>RPO</strong>) is the highest amount of data
that a stakeholder is willing to loose in case of a disaster, while the
Recovery Time Objective (<strong>RTO</strong>) is the highest amount of time that a
stakeholder is willing to wait to recover its data.</p>
<p>According to these definitions, the ideal acceptable value zero, while
the realistic values are usually near zero, depending on the size of the
data. In Zextras, the combination of Real Time Scan and SmartScan
guarantees that both RTO and RPO values are quite low: The Real Time
Scanner ensures that all metadata changes are recorded as soon as they
change, while the SmartScan copies all items that have been modified,
hence the possible loss of data is minimised and usually limited to
those items that have changed between two consecutive run on SmartScan.</p>
<section id="item">
<span id="id5"></span><h3><a class="toc-backref" href="#id82">Item</a><a class="headerlink" href="#item" title="Permalink to this headline"></a></h3>
<p>The whole architecture of Zextras Backup revolves around the concept of
<strong>ITEM</strong>: An <strong>item</strong> is the minimum object that is stored in the
backup, for example:</p>
<ul class="simple">
<li><p>an email message</p></li>
<li><p>a contact or a group of contacts</p></li>
<li><p>a folder</p></li>
<li><p>an appointment</p></li>
<li><p>a task</p></li>
<li><p>a Drive document</p></li>
<li><p>an account (including its settings)</p></li>
<li><p>a distribution list</p></li>
<li><p>a domain</p></li>
<li><p>a class of services (COS)</p></li>
</ul>
<blockquote>
<div><p><strong>Note</strong></p>
<p>the last three items (distribution lists, domains, classes of
services) are subject to the SmartScan <strong>only</strong>, i.e., the Real Time
Scan will <strong>not</strong> record any change of their state.</p>
</div></blockquote>
<p>There are also objects that are <strong>not</strong> items, and as such will never be
scanned for changes by the Real Time Scan and will never be part of a
restore:</p>
<ul class="simple">
<li><p>Server settings, i.e., the configuration of each server</p></li>
<li><p>Global settings of Zextras product</p></li>
<li><p>Any customizations made to the software (Postfix, Jetty, etc…​)</p></li>
</ul>
<p>For every item managed by Zextras Suite, every variation in its
associated metadata is recorded and saved, allowing its restore at a
given point in time. In other words, whenever one of the metadata
associated with an item changes, a “photograph” of the whole item is
taken and stored with a timestamp be means of a <strong>transaction</strong>.
Examples of metadata associated to an item include:</p>
<ul class="simple">
<li><p>when the email was read, deleted, moved to a folder</p></li>
<li><p>a change in the name/address/job of a contact</p></li>
<li><p>the deletion or addition of a file in a folder</p></li>
<li><p>the change of status of an item (e.g, an account)</p></li>
</ul>
<p>Technically, an item is stored as a <strong>JSON</strong> Array containing all
changes in the item’s lifetime. More about this in the <a class="reference external" href="#_structure_of_an_item">Structure of an
Item</a> section.</p>
<p>A <strong>Deleted Item</strong> is an item that has been marked for removal.</p>
<blockquote>
<div><p><strong>Note</strong></p>
<p>An element in the thrash bin is not considered as a <strong>deleted item</strong>:
It is a regular item, placed in a folder that is special only to us,
from the Zextras Backup’s point of view, the item has only changed
its state when moved to the thrash bin.</p>
</div></blockquote>
</section>
<section id="transaction">
<span id="id6"></span><h3><a class="toc-backref" href="#id83">Transaction</a><a class="headerlink" href="#transaction" title="Permalink to this headline"></a></h3>
<p>A <strong>Transaction</strong> is a change of state of an item. With change of state
we mean that one of the metadata associated with an item is modified by
a user. Therefore, a <strong>Transaction</strong> can be seen as a photography of the
metadata in a moment in time. Each transaction is uniquely identified by
a <strong>Transaction ID</strong>. It is possible to restore an item to any past
transaction. See more in section
<a class="reference external" href="restorestrategies.xml">restorestrategies.xml</a>.</p>
</section>
<section id="smartscan-and-real-time-scan">
<span id="id7"></span><h3><a class="toc-backref" href="#id84">SmartScan and Real Time Scan</a><a class="headerlink" href="#smartscan-and-real-time-scan" title="Permalink to this headline"></a></h3>
<p>The initial structure of the backup is built during the <em>Initial Scan</em>,
performed by the <strong>SmartScan</strong>: the actual content of a Mailbox is read
and used to populate the backup. The SmartScan is then executed at every
start of the module and on a daily basis if the <strong>Scan Operation
Scheduling</strong> is enabled in the Administration Zimlet.</p>
<blockquote>
<div><p><strong>Important</strong></p>
<p>SmartScan runs at a fixed time—​that can be configured—​on a daily
basis and is not deferred. This implies that, if for any reason (like
e.g., the server is turned off, or Zextras is not running), SmartScan
does <strong>not run</strong>, it will <strong>not run</strong> until the next day. You may
however configure the Backup to run the SmartScan every time Zextras
Suite is restarted (although this is discouraged), or you may
manually run SmartScan to compensate for the missing run.</p>
</div></blockquote>
<p>SmartScan’s main purpose is to check for items modified since its
previous run and to update the database with any new information.</p>
<p>The <strong>Real Time Scan</strong> records live every event that takes place on the
system, allowing for a possible recovery with a split-second precision.
The Real Time Scanner does not overwrite any data in the backup, so
every item has an own complete history. Moreover, it has the ability to
detect there are more changes that relate to the same item in the same
moment and record all them as a single metadata change.</p>
<p>Both SmartScan and Real Time Scan are enabled by default. While both can
be (independently) stopped, it is suggested to leave them running, as
they are intended to complement each other.</p>
<blockquote>
<div><p><strong>Warning</strong></p>
<p>If none of the two Scan Operations is active, no backup is created.</p>
</div></blockquote>
<p>Backups are written on disk, therefore the Scan operations result in I/O
disk access. Therefore, there are a number of scenarios in which either
of the SmartScan or Real Time Scan might (or should) be disabled, even
temporarily. For example:</p>
<ul class="simple">
<li><p>You have a high number of trasactions every day (or you often work
with Drive documents) and notice a high load in the server’s resource
consumption. In this case you can temporarily disable the Real Time
Scan.</p></li>
<li><p>You start a migration: In this case it is suggested to stop the
SmartScan, because it would create a lot of I/O operations on disk
and even block the server. Indeed, it would treat every migrated or
restored item as a new one.</p></li>
<li><p>You have a high traffic of incoming and outgoing emails per day. In
this case, you should always have the Real Time Scan active, because
otherwise all transactions will be backed up <strong>only</strong> by the
SmartScan, which might not be able to complete in a reasonable time,
due to the resources required for the I/O operations.</p></li>
</ul>
</section>
<section id="backup-path">
<span id="id8"></span><h3><a class="toc-backref" href="#id85">Backup Path</a><a class="headerlink" href="#backup-path" title="Permalink to this headline"></a></h3>
<p>The backup path is the place on a filesystem where all the information
about the backup and archives is stored. Each server has exactly one
backup path; different servers can not share the same backup path. It is
structured as a hierarchy of folders, the topmost of which is by default
<code class="docutils literal notranslate"><span class="pre">/opt/zimbra/backup/zextras/</span></code>. Under this directory, the following
important files and directories are present:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">map_[server_ID]</span></code> are so-called <strong>map files</strong>, that show if the
Backup has been imported from an external backup and contain in the
filename the unique ID of the server.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accounts</span></code> is a directory under which information of all accounts
defined in the Mailbox are present. In particular, the following
important files and directories can be found there:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">account_info</span></code> is a file that stores all metadata of the
account, including password, signature, preferences</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">account_stat</span></code> is a file containing various statistics about the
account, like for example the ID of the last element stored by
SmartScan</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">backupstat</span></code> is a file that maintains generic statistics about
the backup, including the timestamp of the first run</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">drive_items</span></code> is a directory containing up to 256 subfolders
(whose name is composed of two hexadecimal lowercase letters),
under which are stored Drive items, according to the last two
letters of their UUID</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">items</span></code> is a directory containing up to 100 subfolders (whose
name is composed of two digits, in which items are stored
according to their ID’s last two digits</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">servers</span></code> is a directory that contains archives of the server
configuration and customisations, Zextras configuration and of the
chat, one per day up to the configured server retention time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">items</span></code> is a directory containing up to 4096 additional folders,
whose name consists of two hexadecimal (uppercae and lowercase)
characters. <strong>Items</strong> in the Mailbox will be stored in the directory
whose name has the last two characters of their ID.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">id_mapper.log</span></code> is a user object ID mapping and contains a map
between the original object and the restored object. It is located at
<code class="docutils literal notranslate"><span class="pre">/backup/zextras/accounts/xxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/id_mapper.log</span></code>.
This file is present only in case of an external restore.</p></li>
</ul>
<blockquote>
<div><p><strong>Community Article:</strong></p>
<p><a class="reference external" href="https://community.zextras.com/zextras-backup-path/">https://community.zextras.com/zextras-backup-path/</a></p>
<p>A more in-depth and comprehensive overview of the Backup Path.</p>
</div></blockquote>
<section id="setting-the-backup-path">
<span id="setting-backup-path"></span><h4>Setting the Backup Path<a class="headerlink" href="#setting-the-backup-path" title="Permalink to this headline"></a></h4>
<p>The Backup Path can be set both via GUI and via CLI:</p>
<ul class="simple">
<li><p>Via GUI: in the “Backup” section of the Zextras Administration
Zimlet, under “Backup Path”.</p></li>
<li><p>Via CLI: using the <a class="reference external" href="../cli.xml#config_server">config server</a>
command to change the <code class="docutils literal notranslate"><span class="pre">ZxBackup_DestPath</span></code> config key.</p></li>
</ul>
<blockquote>
<div><p><strong>Warning</strong></p>
<p>Backup paths are unique and not reusable. Copying a Backup Path to a
new server and setting it as its current Backup Path will return an
error, and forcing this in any way by tampering with the backup file
will cause corruption of both old and new backup data.</p>
</div></blockquote>
</section>
</section>
<section id="retention-policy">
<span id="id9"></span><h3><a class="toc-backref" href="#id86">Retention Policy</a><a class="headerlink" href="#retention-policy" title="Permalink to this headline"></a></h3>
<p>The Retention Policy (also retention time) defines after how many days
an object marked for deletion is actually removed from the backup. The
retention policies in the Backup are:</p>
<ul class="simple">
<li><p><strong>Data retention policy</strong> concerns the single items, defaults to
<strong>30</strong> days</p></li>
<li><p><strong>Account retention policy</strong> refers to the accounts, defaults to
<strong>30</strong> days</p></li>
</ul>
<p>All retention times can be changed; if set to <strong>0</strong> (zero), archives
will be kept forever (<strong>infinite retention</strong>) and the Backup Purge will
not run.</p>
<p>In case an account is deleted and must be restored after the <strong>Data
retention time</strong> has expired, it will be nonetheless possible to recover
all items up to the <strong>Account retention time</strong>, because in that case,
even if all the metadata have been purged, the digest can still contain
the information required to restore the item.</p>
</section>
<section id="backup-purge">
<span id="id10"></span><h3><a class="toc-backref" href="#id87">Backup Purge</a><a class="headerlink" href="#backup-purge" title="Permalink to this headline"></a></h3>
<p>The Backup Purge is a cleanup operation that removes from the Backup
Path any deleted item that exceeded the retention time defined by the
<strong>Data Retention Policy</strong> and <strong>Account retention policy</strong>.</p>
</section>
<section id="coherency-check">
<span id="id11"></span><h3><a class="toc-backref" href="#id88">Coherency Check</a><a class="headerlink" href="#coherency-check" title="Permalink to this headline"></a></h3>
<p>The Coherency Check is specifically designed to detect corrupted
metadata and BLOBs and performs a deeper check of a Backup Path than
SmartScan.</p>
<p>While the SmartScan works <em>incrementally</em> by only checking items
modified since the last SmartScan run, the <strong>Coherency Check</strong> carries
out a thorough check of all metadata and BLOBs in the Backup Path.</p>
<p>To start a Coherency Check via the CLI, use the
<a class="reference external" href="../cli.xml#backup_doCoherencyCheck">doCoherencyCheck</a> command:</p>
<p>Quick reference</p>
<div class="informalexample docutils container">
<p>zxsuite backup doCoherencyCheck <em>backup_path</em> [param VALUE[,VALUE]]</p>
</div>
<blockquote>
<div><p><strong>Community Article:</strong></p>
<p><a class="reference external" href="https://community.zextras.com/coherency-check/">https://community.zextras.com/coherency-check/</a></p>
<p>A detailed analysis of the Coherency Check</p>
</div></blockquote>
</section>
<section id="how-zextras-backup-works">
<span id="id12"></span><h3><a class="toc-backref" href="#id89">How Zextras Backup Works</a><a class="headerlink" href="#how-zextras-backup-works" title="Permalink to this headline"></a></h3>
<p>Zextras Backup has been designed to store each and every variation of an
<strong>ITEM</strong>. It is not intended as a system or Operating System backup,
therefore it can work with different OS architecture and Zimbra
versions.</p>
<p>Zextras Backup allows administrators to create an atomic backup of every
item in the mailbox account and restore different objects on different
accounts or even on different servers.</p>
<p>By default, the default Zextras Backup setting is to save all backup
files in the <strong>local directory</strong> <code class="docutils literal notranslate"><span class="pre">/opt/zimbra/backup/zextras/</span></code>. In
order to be eligible to be used as the Backup Path, a directory must:</p>
<ul class="simple">
<li><p>Be both readable and writable by the <code class="docutils literal notranslate"><span class="pre">zimbra</span></code> user.</p></li>
<li><p>Use a case sensitive filesystem.</p></li>
</ul>
<blockquote>
<div><p><strong>Tip</strong></p>
<p>You can modify the default setting by using either technique shown in
<a class="reference external" href="#setting-backup-path">Setting the Backup Path</a>.</p>
</div></blockquote>
<p>When first started, Zextras Backup launches a SmartScan, to fetch from
the mailbox all data and create the initial backup structure, in which
every item is saved along with all its metadata as a JSON array on a
case sensitive filesystem. After the first start, either the Real Time
Scanner, the SmartScan, or both can be employed to keep the backup
updated and synchronised with the account.</p>
<section id="id14">
<span id="id15"></span><h4>Structure of an Item<a class="headerlink" href="#id14" title="Permalink to this headline"></a></h4>
<p>The basic structure of the item is a <strong>JSON Array</strong> that records all the
changes happening during the lifetime of each item, such as information
related to emails (e.g., tags, visibility, email moved to a folder),
contacts, tasks, single folders, groups, or drive documents, user’s
preferences (e.g., hash of the password, general settings).</p>
<p>To improve performance, only the changes that are needed to restore the
items are recorded: for example is not useful to store the user’s last
login time or the IMAP and Activesync state, because if the account will
be restored on a new one, the values of that attributes would be related
to the old account.</p>
<p>By collecting the timestamp of the transaction, we are able to restore
data at a specific moment of its life.</p>
<p>During the restore, the engine looks at all the transactions valid
evaluating the “start-date” and “end-date” attributes.</p>
<p>The same logic is used to retrieve deleted items: when an item is
deleted we store the timestamp and so, we are able to restore items that
have been deleted within a specific time frame.</p>
<p>Even if the blob associated to the item changes, and consequently its
digest changes too (as happens for Drive Document), the metadata records
the validity of the old and the new digest.</p>
</section>
</section>
<section id="backup-of-team-database">
<span id="id16"></span><h3><a class="toc-backref" href="#id90">Backup of Team Database</a><a class="headerlink" href="#backup-of-team-database" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="team.xml">Zextras Team</a> is an instant messaging platform with a
number of features, including file sharing, Web conferencing, and more.
Since Team keeps track of everything (uploaded files, chat, and so on),
its database can grow quickly to a large size: This slows down any
Backup operations and is not usable for a restore operation.</p>
<p>For this reason, the backup of Team’s DB has been disabled by default.
An Administrator may enable it, in theory, <strong>but only after having
contacted beforehand a TSE</strong> (Technical Support Engineer).</p>
</section>
</section>
<section id="id17">
<span id="id18"></span><h2><a class="toc-backref" href="#id91">SmartScan</a><a class="headerlink" href="#id17" title="Permalink to this headline"></a></h2>
<section id="what-is-the-smartscan">
<span id="id19"></span><h3><a class="toc-backref" href="#id92">What is the SmartScan?</a><a class="headerlink" href="#what-is-the-smartscan" title="Permalink to this headline"></a></h3>
<p>The SmartScan operates only on accounts that have been modified since
the previous SmartScan, hence it can improve the system’s performances
and decrease the scan time exponentially.</p>
<p>By default, a SmartScan is scheduled to be executed each night (if
<code class="docutils literal notranslate"><span class="pre">Scan</span>
<span class="pre">Operation</span> <span class="pre">Scheduling</span></code> is enabled in the Zextras Backup section of the
Administration Zimlet). Once a week, on a day set by the user, a Purge
is executed together with the SmartScan to clear Zextras Backup’s
datastore from any deleted item that exceeded the retention period.</p>
</section>
<section id="how-does-it-work">
<span id="id20"></span><h3><a class="toc-backref" href="#id93">How Does it Work?</a><a class="headerlink" href="#how-does-it-work" title="Permalink to this headline"></a></h3>
<p>The Zextras Backup engine scans all the items on the Zimbra Datastore,
looking for items modified after the last SmartScan. It updates any
outdated entry and creates any item not yet present in the backup while
flagging as deleted any item found in the backup and not in the Zimbra
datastore.</p>
<p>Then, all configuration metadata in the backup are updated, so that
domains, accounts, COSs and server configurations are stored along with
a dump of all configuration.</p>
<p>When LDAP is part of the setup, SmartScan will save in the Backup Path a
compressed LDAP dump that can also be used standalone to restore a
broken LDAP configuration.</p>
<blockquote>
<div><p><strong>Note</strong></p>
<p>In case the LDAP backup can not be executed (e.g., because the access
credential are wrong or invalid, SmartScan will simply ignore to back
up the LDAP configuration, but will nonetheless save a backup of all
the remaining configuration</p>
</div></blockquote>
<p>When the Backup on External Volume functionality is active, SmartScan
creates one (daily) archive for each account which include all the
account’s metadata and stores it on the external volume. More
information in section <a class="reference external" href="#external-backup">???</a>.</p>
</section>
<section id="when-is-a-smartscan-executed">
<span id="id22"></span><h3><a class="toc-backref" href="#id94">When is a SmartScan Executed?</a><a class="headerlink" href="#when-is-a-smartscan-executed" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>When the Zextras Backup module is started.</p></li>
</ul>
<blockquote>
<div><p><strong>Note</strong></p>
<p>While it is possible to enable this option, it is suggested to leave
it disabled, because in certain situations, running SmartScan at
every module restart can become a performance bottleneck, as it has
been <a class="reference external" href="#disable-scan">discussed previously</a>. * Daily, if the Scan
Operation Scheduling is enabled in the Administration Zimlet * When
the Real Time Scanner is re-enabled via the Administration Zimlet
after being previously disabled</p>
</div></blockquote>
</section>
<section id="running-a-smartscan">
<span id="id23"></span><h3><a class="toc-backref" href="#id95">Running a SmartScan</a><a class="headerlink" href="#running-a-smartscan" title="Permalink to this headline"></a></h3>
<section id="starting-the-scan-via-the-administration-zimlet">
<span id="id24"></span><h4>Starting the Scan via the Administration Zimlet<a class="headerlink" href="#starting-the-scan-via-the-administration-zimlet" title="Permalink to this headline"></a></h4>
<p>To start a SmartScan via the Administration Zimlet,</p>
<ul class="simple">
<li><p>Open the Administration Zimlet</p></li>
<li><p>If a multiserver installation, choose the server on which to run the
SmartScan</p></li>
<li><p>Click on the Zextras Backup tab</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">Smartscan</span></code></p></li>
</ul>
</section>
<section id="starting-the-smartscan-via-the-cli">
<span id="id25"></span><h4>Starting the SmartScan via the CLI<a class="headerlink" href="#starting-the-smartscan-via-the-cli" title="Permalink to this headline"></a></h4>
<p>To start a SmartScan via the CLI, use the
<a class="reference external" href="../cli.xml#backup_doSmartScan">doSmartScan</a> command:</p>
<div class="informalexample docutils container">
<p>zxsuite backup doSmartScan <em>start</em> [param VALUE[,VALUE]]</p>
</div>
</section>
<section id="checking-the-status-of-a-running-scan">
<span id="id26"></span><h4>Checking the Status of a Running Scan<a class="headerlink" href="#checking-the-status-of-a-running-scan" title="Permalink to this headline"></a></h4>
<p>Before actually carrying out this check, it is suggested to verify how
many operations are running, to find the correct id. you can do this by
using the <a class="reference external" href="../cli.xml#backup_getAllOperations">getAllOperations</a>
command:</p>
<div class="informalexample docutils container">
<p>zxsuite backup getAllOperations [param VALUE[,VALUE]]</p>
</div>
<p>To check the status of a running scan via the CLI, use the
<a class="reference external" href="../cli.xml#backup_monitor">monitor</a> command:</p>
<div class="informalexample docutils container">
<p>zxsuite backup monitor <em>operation_uuid</em> [param VALUE[,VALUE]]</p>
</div>
</section>
</section>
</section>
<section id="real-time-scan">
<span id="id27"></span><h2><a class="toc-backref" href="#id96">Real Time Scan</a><a class="headerlink" href="#real-time-scan" title="Permalink to this headline"></a></h2>
<section id="what-is-the-real-time-scanner">
<span id="id28"></span><h3><a class="toc-backref" href="#id97">What is the Real Time Scanner?</a><a class="headerlink" href="#what-is-the-real-time-scanner" title="Permalink to this headline"></a></h3>
<p>The Real Time Scan is an engine tightly connected to the Mailbox, which
intercepts all the transactions that take place on each user’s mailbox
and records them with the purpose of maintaining the whole history of an
item for its entire lifetime.</p>
<p>Thanks to the Real Time Scan, it is possible to recover any item at any
point in time.</p>
</section>
<section id="how-does-it-work-2">
<span id="id29"></span><h3><a class="toc-backref" href="#id98">How Does it Work?</a><a class="headerlink" href="#how-does-it-work-2" title="Permalink to this headline"></a></h3>
<p>The Real Time Scanner reads all the events of the mail server almost
real-time, then it ‘replicates’ the same operations on its own data
structure, creating items or updating their metadata. No information is
ever overwritten in the backup, so every item has its own complete
history.</p>
</section>
<section id="managing-the-real-time-scanner">
<span id="id30"></span><h3><a class="toc-backref" href="#id99">Managing the Real Time Scanner</a><a class="headerlink" href="#managing-the-real-time-scanner" title="Permalink to this headline"></a></h3>
<section id="enabling-the-real-time-scanner">
<span id="id31"></span><h4>Enabling the Real Time Scanner<a class="headerlink" href="#enabling-the-real-time-scanner" title="Permalink to this headline"></a></h4>
<section id="via-the-administration-zimlet">
<span id="id32"></span><h5>Via the Administration Zimlet<a class="headerlink" href="#via-the-administration-zimlet" title="Permalink to this headline"></a></h5>
<ul class="simple">
<li><p>Select the Zextras Backup Tab.</p></li>
<li><p>Under Real Time Scanner, press the <code class="docutils literal notranslate"><span class="pre">Enable</span></code> button.</p></li>
</ul>
<blockquote>
<div><p><strong>Note</strong></p>
<p>When the Real Time Scanner is enabled for the first time or
re-enabled after a stop, a SmartScan is required. A warning will be
displayed after enabling the Real Time Scanner, and you will be
prompted to start the SmartScan.</p>
</div></blockquote>
</section>
<section id="via-the-cli">
<span id="id33"></span><h5>Via the CLI<a class="headerlink" href="#via-the-cli" title="Permalink to this headline"></a></h5>
<p>To enable the Real Time Scanner via the CLI, the
<code class="docutils literal notranslate"><span class="pre">ZxBackup_RealTimeScanner</span></code> property of the Zextras Backup module must
be set to <code class="docutils literal notranslate"><span class="pre">true</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>zxsuite config server set $(zmhostname) attribute ZxBackup_RealTimeScanner value TRUE
</pre></div>
</div>
</section>
</section>
<section id="disabling-the-real-time-scanner">
<span id="id34"></span><h4>Disabling the Real Time Scanner<a class="headerlink" href="#disabling-the-real-time-scanner" title="Permalink to this headline"></a></h4>
<section id="via-the-administration-zimlet-2">
<span id="id35"></span><h5>Via the Administration Zimlet<a class="headerlink" href="#via-the-administration-zimlet-2" title="Permalink to this headline"></a></h5>
<ul class="simple">
<li><p>Select the Zextras Backup Tab.</p></li>
<li><p>Under Real Time Scanner, press the <code class="docutils literal notranslate"><span class="pre">Disable</span></code> button.</p></li>
</ul>
</section>
<section id="via-the-cli-2">
<span id="id36"></span><h5>Via the CLI<a class="headerlink" href="#via-the-cli-2" title="Permalink to this headline"></a></h5>
<p>To disable the Real Time Scanner via the CLI, the
<code class="docutils literal notranslate"><span class="pre">ZxBackup_RealTimeScanner</span></code> property of the Zextras Backup module must
be set to <code class="docutils literal notranslate"><span class="pre">false</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>zxsuite config server set $(zmhostname) attribute ZxBackup_RealTimeScanner value FALSE
</pre></div>
</div>
</section>
<section id="why-should-i-disable-the-real-time-scanner">
<span id="id37"></span><h5>Why Should I Disable the Real Time Scanner?<a class="headerlink" href="#why-should-i-disable-the-real-time-scanner" title="Permalink to this headline"></a></h5>
<p>The only time you should disable the Real Time Scanner is while
performing an External Restore of multiple domains. This is a safety
measure to avoid high load on your server. After the import, re-enable
the Real Time Scanner and perform a SmartScan when prompted.</p>
</section>
</section>
<section id="limitations-and-safety-scan">
<span id="id38"></span><h4>Limitations and Safety Scan<a class="headerlink" href="#limitations-and-safety-scan" title="Permalink to this headline"></a></h4>
<p>The main limitation when restoring data acquired via the Real Time
Scanner is:</p>
<ul class="simple">
<li><p><strong>Emptied Folder</strong> - when a user uses the <code class="docutils literal notranslate"><span class="pre">Empty</span> <span class="pre">Folder</span></code> button in
the right-click context menu</p></li>
</ul>
<p>In this case, and any time Zextras Backup cannot determine the status of
an item by reading the metadata saved by the Real Time Scan, an Account
Scan on the given account is triggered BEFORE the restore.</p>
<p>This fixes any misaligned data and sanitizes the backed up metadata for
the mailbox.</p>
</section>
</section>
</section>
<section id="backup-purge-2">
<span id="id39"></span><h2><a class="toc-backref" href="#id100">Backup Purge</a><a class="headerlink" href="#backup-purge-2" title="Permalink to this headline"></a></h2>
<section id="what-is-the-backup-purge">
<span id="id40"></span><h3><a class="toc-backref" href="#id101">What is the Backup Purge?</a><a class="headerlink" href="#what-is-the-backup-purge" title="Permalink to this headline"></a></h3>
<p>The Backup Purge is a cleanup operation that removes from the Backup
Path any deleted item that exceeded the retention time defined by the
<a class="reference external" href="#_retention_policy">Data Retention Policy</a>.</p>
</section>
<section id="how-does-it-work-3">
<span id="id41"></span><h3><a class="toc-backref" href="#id102">How Does it Work?</a><a class="headerlink" href="#how-does-it-work-3" title="Permalink to this headline"></a></h3>
<p>The Purge engine scans the metadata of all the deleted items and when it
finds an item marked for deletion whose last update is older than the
retention time period, it erases it from the backup.</p>
<p>Note however, that if an item BLOB is still referenced by one or more
valid metadata files, due to Zextras Backup’s built-in deduplication,
the BLOB itself will not be deleted.</p>
<p>Customizations backed up by Zextras Backup also follow the Backup Path’s
purge policies. This can be changed in the <code class="docutils literal notranslate"><span class="pre">`Zextras</span> <span class="pre">Backup</span></code>
section of the Administration Zimlet by unchecking the
<code class="docutils literal notranslate"><span class="pre">Purge</span> <span class="pre">old</span> <span class="pre">customizations</span></code> checkbox.</p>
</section>
<section id="when-is-a-backup-purge-executed">
<span id="id42"></span><h3><a class="toc-backref" href="#id103">When is a Backup Purge Executed?</a><a class="headerlink" href="#when-is-a-backup-purge-executed" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Weekly, if the Scan Operation Scheduling is enabled in the
Administration Zimlet</p></li>
<li><p>When manually started either via the Administration Console or the
CLI</p></li>
</ul>
<p>With <strong>infinite retention</strong> active (i.e., the <em>Data Retention Policy</em> is
set to <strong>0</strong>), the Backup Purge will immediately exit since no deleted
item will ever exceed the retention time.</p>
</section>
<section id="running-a-backup-purge">
<span id="id43"></span><h3><a class="toc-backref" href="#id104">Running a Backup Purge</a><a class="headerlink" href="#running-a-backup-purge" title="Permalink to this headline"></a></h3>
<section id="starting-the-backup-purge-via-the-administration-zimlet">
<span id="id44"></span><h4>Starting the Backup Purge via the Administration Zimlet<a class="headerlink" href="#starting-the-backup-purge-via-the-administration-zimlet" title="Permalink to this headline"></a></h4>
<p>To start a BackupPurge via the Administration Zimlet:</p>
<ul class="simple">
<li><p>Click the Zextras Backup tab (be sure to have a valid license).</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">Purge</span></code> button in the top-right part of the UI.</p></li>
</ul>
</section>
<section id="starting-the-backup-purge-via-the-cli">
<span id="id45"></span><h4>Starting the Backup Purge via the CLI<a class="headerlink" href="#starting-the-backup-purge-via-the-cli" title="Permalink to this headline"></a></h4>
<p>To start a BackupPurge via the CLI, use the
<a class="reference external" href="../cli.xml#backup_doPurge">doPurge</a> command:</p>
<div class="informalexample docutils container">
<p>zxsuite backup doPurge [param VALUE[,VALUE]]</p>
</div>
</section>
<section id="checking-the-status-of-a-running-backup-purge">
<span id="id46"></span><h4>Checking the Status of a Running Backup Purge<a class="headerlink" href="#checking-the-status-of-a-running-backup-purge" title="Permalink to this headline"></a></h4>
<p>To check the status of a running Purge via the CLI, use the
<a class="reference external" href="../cli.xml#backup_monitor">monitor</a> command:</p>
<div class="informalexample docutils container">
<p>zxsuite backup monitor <em>operation_uuid</em> [param VALUE[,VALUE]]</p>
</div>
</section>
</section>
</section>
<section id="limitations-and-corner-cases-of-the-backup">
<span id="id48"></span><h2><a class="toc-backref" href="#id105">Limitations and Corner Cases of the Backup</a><a class="headerlink" href="#limitations-and-corner-cases-of-the-backup" title="Permalink to this headline"></a></h2>
<p>There are a few cases in which the backup is not working correctly. We
discuss those cases here.</p>
<ol class="arabic simple">
<li><p>Restore of an active account on a new account should NOT be done
using the latest state available. Suppose that a user by mistake
deletes all of his emails or that for any reason (like e.g., a server
failure) the emails in an account are lost. The user wants them back
and asks the admin. If the admin restores the status of the account
to the <strong>latest state available</strong>, the result is that the new account
will contain the latest state available, which is an <strong>empty
account</strong>, since in the latest state the email have already been
deleted. Therefore, in order to correctly restore the account, it is
necessary to restore it at a point in time which is <strong>antecedent</strong>
the emails were deleted.</p></li>
</ol>
<ol class="arabic simple">
<li><p>When using the <strong>POP3/POP3S</strong> protocol, if the email client is
configured to download email messages and delete them immediately
from the server, these messages may not be included in the backup.
This does not happen if the Zextras Powerstore component is
installed.</p></li>
<li><p>When sending an email directly through an SMTP connection (e.g.,
using a multipurpose device or connecting to the STMP server using
<code class="docutils literal notranslate"><span class="pre">telnet</span></code>), then that email will not be part of the backup.</p></li>
<li><p>When sending email using an IMAP/SMTP client, the IMAP client must be
configured to store the send email in a remote folder (using the IMAP
STORE command) after the send operation, otherwise the email may not
be included in the backup.</p></li>
</ol>
<blockquote>
<div><p><strong>Note</strong></p>
<p>The last two cases do not apply when using a browser to connect to
the Mailbox. In this case is it the Mailbox that contacts the SMTP
server to send the email and automatically passes the email to
<code class="docutils literal notranslate"><span class="pre">mailboxd</span></code>.</p>
</div></blockquote>
<section id="troubleshooting-ldap-backup">
<span id="id49"></span><h3><a class="toc-backref" href="#id106">Troubleshooting LDAP Backup</a><a class="headerlink" href="#troubleshooting-ldap-backup" title="Permalink to this headline"></a></h3>
<p>In some cases, when backing up a mailbox server, the backup of only the
LDAP data may fail and completes with a warning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Unable to backup LDAP config schema: missing `ldap_root_password` in localconfig.
</pre></div>
</div>
<p>In this section we provide some suggestions to tackle this problem.</p>
<section id="increase-log-verbosity">
<span id="id50"></span><h4>Increase Log Verbosity<a class="headerlink" href="#increase-log-verbosity" title="Permalink to this headline"></a></h4>
<p>Depending on the mailbox server configuration, a number of log messages
are saved in the log file. In case an LDAP backup fails and the log file
does not report enough messages to identify the root cause of the
failure, a first solution is to increase the <strong>verbosity</strong> of the log
file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zxsuite config server <span class="nb">set</span> <span class="k">$(</span>zmhostname<span class="k">)</span> attribute ZxCore_LogLevel value <span class="m">0</span>
</pre></div>
</div>
<p>Now, run a backup using the following command (that only backs up the
LDAP data) and check again the log file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zxsuite --json backup doBackupLDAP start
</pre></div>
</div>
<p>After the command completes and you have finished analysing the log
file, remember to restore the verbosity to the previous level:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zxsuite config server <span class="nb">set</span> <span class="k">$(</span>zmhostname<span class="k">)</span> attribute ZxCore_LogLevel value <span class="m">1</span>
</pre></div>
</div>
<blockquote>
<div><p><strong>Tip</strong></p>
<p>Increasing log verbosity can prove useful whenever troubleshooting a
problem or searching for more information about a problem.</p>
</div></blockquote>
</section>
<section id="missing-root-credentials">
<span id="id51"></span><h4>Missing root credentials<a class="headerlink" href="#missing-root-credentials" title="Permalink to this headline"></a></h4>
<p>To be able to back up LDAP data, Zextras Suite needs to establish a
remote connection to the LDAP server using <strong>LDAP root credentials</strong>.</p>
<p>In particular, the password is saved in the <strong>Zimbra localconfig</strong>, but
on a mailbox server where the LDAP component is not installed, the
<strong>LDAP root password</strong> is empty. Therefore, the LDAP connection
<strong>fails</strong> with an <strong>invalid credentials error</strong> and the backup of the
LDAP data is not produced.</p>
<p>This situation can be verified by using the following sequence of
commands on a mailbox server:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>su - zimbra
<span class="nb">source</span> bin/zmshutil
zmsetvars
ldapwhoami -x -D <span class="nv">$zimbra_ldap_userdn</span> -w <span class="nv">$zimbra_ldap_password</span> -H <span class="nv">$ldap_master_url</span>
</pre></div>
</div>
<p>The last command should complete with output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span><span class="n">uid</span><span class="o">=</span><span class="n">zimbra</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">admins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">zimbra</span>
</pre></div>
</div>
<p>Now, running the command</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ldapwhoami -x -D <span class="s2">&quot;cn=config&quot;</span> -w <span class="nv">$ldap_root_password</span> -H <span class="nv">$ldap_master_url</span>
</pre></div>
</div>
<p>should output <code class="docutils literal notranslate"><span class="pre">dn:cn=config</span></code>. If this is <strong>not</strong> the case, then the
LDAP root password is either wrong or not stored in the local
configuration.</p>
<p>To fix the problem, follow this three step procedure.</p>
<p><strong>1. Discover the ldap master server.</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zmlocalconfig ldap_master_url
</pre></div>
</div>
<p><strong>2. Connect to the ldap master server and obtain the root password.</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zmlocalconfig -s ldap_root_password
</pre></div>
</div>
<p>This command will output the password that you need then to store on all
mailbox servers on which either <code class="docutils literal notranslate"><span class="pre">zxsuite</span></code> is running, LDAP backup is
enabled, or both.</p>
<p><strong>3. Save password on all mailstores.</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>su - zimbra
zmlocalconfig -e -f <span class="nv">ldap_root_password</span><span class="o">=</span><span class="s2">&quot;Password From Previous command&quot;</span>
restart the mailbox service to avoid cached credentials problems
zmmailboxdctl restart
</pre></div>
</div>
</section>
<section id="disable-ldap-backup">
<span id="id52"></span><h4>Disable LDAP Backup<a class="headerlink" href="#disable-ldap-backup" title="Permalink to this headline"></a></h4>
<p>In case you do not want to backup LDAP data together with Zextras suite,
you can disable it entirely. On each mailbox server, to disable LDAP
Backup, run this command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zxsuite config <span class="nb">set</span> server <span class="k">$(</span>zmhostname<span class="k">)</span> ldapDumpEnabled <span class="nb">false</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="backup-on-external-storage">
<span id="id53"></span><h2><a class="toc-backref" href="#id107">Backup on external storage</a><a class="headerlink" href="#backup-on-external-storage" title="Permalink to this headline"></a></h2>
<p>To prevent misunderstandings, the sections <strong>Backup on a Third Party
Store</strong> and <strong>External Backup</strong> have been merged and use now a more
precise terminology. The corresponding Zextras Suite functionalities
have not changed.</p>
<p>As described in section <a class="reference external" href="#backup-architecture">Architecture of Zextras
Backup</a>, Zextras Backup is composed of metadata
and blobs (compressed and deduplicated), saved by default on the same
folder—​or mounted volume—​specified in the <em>Backup Path</em>. The real-time
backup requires the Backup Path be fast enough to avoid queuing
operations and/or risk data loss.</p>
<p>However, S3 buckets, NFS shares, and other storage mounted using Fuse
can be very slow and might not be suited as storage mounted on the
Backup Path.</p>
<p>Because the most important part of backups is the metadata, the idea
behind <strong>Backup on External Storage</strong> is to use two different storages:
one local (and typically fast) for metadata and cache and one external
(local network or cloud) for the blobs and a copy of metadata.</p>
<p>If the external storage is remote, multiple changes will be bundled and
sent together, while if it is local, larger but slower and cheaper
storages can be employed.</p>
<section id="how-the-backup-on-external-storage-works">
<span id="id55"></span><h3><a class="toc-backref" href="#id108">How the Backup on external storage works</a><a class="headerlink" href="#how-the-backup-on-external-storage-works" title="Permalink to this headline"></a></h3>
<p>Metadata are saved locally in the Backup Path, BLOBs are momentarily
cached on the local disk and uploaded to the remote storage as soon as
possible.</p>
<p>The SmartScan locally updates the metadata for accounts that have been
modified since the previous scan and archives them on the remote
storage.</p>
<p>The remote metadata archiving can be also triggered manually by running
either of the following commands and adding the
<code class="docutils literal notranslate"><span class="pre">remote_metadata_upload</span> <span class="pre">true</span></code> parameter:</p>
<ul class="simple">
<li><p><a class="reference external" href="./cli.xml#backup_doSmartScan">doSmartScan</a></p></li>
<li><p><a class="reference external" href="./cli.xml#backup_doAccountScan">doAccountScan</a></p></li>
<li><p><a class="reference external" href="./cli.xml#backup_doBackupServerCustomizations">doBackupServerCustomizations</a></p></li>
<li><p><a class="reference external" href="./cli.xml#backup_doBackupLDAP">doBackupLDAP</a></p></li>
<li><p><a class="reference external" href="./cli.xml#backup_doBackupCluster">doBackupCluster</a></p></li>
</ul>
<p>By splitting the <em>I/O intensive</em> metadata folder from the BLOBs one, it
is also ensured that the backup works, even in case the remote storage
<strong>is temporarily unavailable</strong>, for example because of network issues or
ongoing maintenance tasks), granting a better reliability and backup
resilience.</p>
<section id="goals-and-benefits">
<span id="id57"></span><h4>Goals and benefits<a class="headerlink" href="#goals-and-benefits" title="Permalink to this headline"></a></h4>
<p>It is worth to highlight the two main advantages of the Backup on
external storage:</p>
<ul class="simple">
<li><p>Fast IOPS storage is needed only for metadata that are statistically
less than 10% of the total backup size.</p></li>
<li><p>Backups are typically stored externally, away from the local
infrastructure and are therefore accessible from disaster recovery
sites</p></li>
</ul>
<blockquote>
<div><p><strong>Important</strong></p>
<p>When activating the Backup on External Storage, it is <strong>not</strong>
possible to modify the Backup Path from the UI. Indeed, the
corresponding input text area will only be shown, but <strong>can not be
edited</strong>. Moreover, the following warning will be shown:</p>
<blockquote>
<div><p>“The backup path cannot be managed using this UI since the Backup
On External Storage is enabled. Please use the backup CLI
commands”</p>
</div></blockquote>
</div></blockquote>
<p>In order to disable the External Storage, you can run the
<a class="reference external" href="./cli.xml#backup_setBackupVolume_Default">setBackupVolume</a> command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>zxsuite backup setBackupVolume Default start
</pre></div>
</div>
</section>
</section>
<section id="data-stored-in-the-external-storage">
<span id="id58"></span><h3><a class="toc-backref" href="#id109">Data stored in the external storage</a><a class="headerlink" href="#data-stored-in-the-external-storage" title="Permalink to this headline"></a></h3>
<p>Data is stored in external storage using a structure very similar to the
one of the Backup Path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>|-- accounts
|-- items
|-- server
`-- backupstat
</pre></div>
</div>
<p>The external volume is used as a storage for the <code class="docutils literal notranslate"><span class="pre">$BACKUP_PATH/items</span></code>
only, while the metadata (which are in <code class="docutils literal notranslate"><span class="pre">$BACKUP_PATH/accounts</span></code>) will
still use the local volume like a working directory to store the changed
metadata.</p>
<p>There is a set of dedicated commands to download the metadata from the
external storage and rebuild the structure and the content of the
account in case of Disaster Recovery or to update/fix local metadata.</p>
<p>For example, this command downloads the latest metadata available in the
remote storage to the Backup Path.</p>
<div class="informalexample docutils container">
<p>zxsuite backup retrieveMetadataFromArchive S3 <em>destination</em></p>
</div>
<p>See documentation of <a class="reference external" href="./cli.xml#backup_retrieveMetadataFromArchive_S3">retrieveMetadataFromArchive
S3</a> for more
information.</p>
</section>
<section id="external-storages">
<span id="id59"></span><h3><a class="toc-backref" href="#id110">External storages</a><a class="headerlink" href="#external-storages" title="Permalink to this headline"></a></h3>
<p>Supported external volumes, i.e. shared volumes mounted either at the OS
level, or object storage entirely managed by Zextras, are of two types:
NFS or Fuse external volumes, which are described in the remainder of
this section.</p>
<section id="nfs-fuse-external-storage">
<span id="nfsfuse-external-storage"></span><h4>NFS/Fuse external storage<a class="headerlink" href="#nfs-fuse-external-storage" title="Permalink to this headline"></a></h4>
<p>Before using the NFS/Fuse share, it is necessary to configure the <strong>new
volume(s)</strong> that will store the backup, because <em>no existent volume can
be reused</em>. Depending on what approach you choose, the steps to carry
out are different. We describe here only the easier and most reliable
one.</p>
<p>Single server installation</p>
<p>When NFS shares are used, you need to make them visible and accessible
to the OS and Zextras, a task that only requires to add a row in
<code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> with the necessary information to mount the volume, for
example, to mount volume /media/mailserver/backup/ from a NAS located at
192.168.72.16 you can add to the bottom of <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> a line similar
to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">192</span>.168.72.16:/media/mailserver/backup/  /media/external/ nfs rw,hard,intr, <span class="m">0</span>,0
</pre></div>
</div>
<p>You will now be able to mount the external storage by simply using
<code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">/media/external/</span></code> on the server.</p>
<p>Multiserver installation</p>
<p>In the case of a multiserver installation, the admin must ensure that
each server writes <strong>on its own directory</strong>, and the destination share
<strong>must</strong> be readable and writable by the zimbra user.</p>
<p>In a multiserver installation, consider a scenario in which the same NAS
located on 192.168.72.16 is involved, which exposes via NFS the share as
<code class="docutils literal notranslate"><span class="pre">/media/externalStorage</span></code>. We want to store our multiservers backups on
this NAS.</p>
<p>To do so, on each server you need to add one entry similar to the
following to <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">192</span>.168.72.16:/externalStorage/Server1 /mnt/backup nfs rw,hard,intr <span class="m">0</span> <span class="m">0</span>

<span class="m">192</span>.168.72.16:/externalStorage/Server2 /mnt/backup nfs rw,hard,intr  <span class="m">0</span> <span class="m">0</span>

<span class="m">192</span>.168.72.16:/externalStorage/Server3 /mnt/backup nfs rw,hard,intr  <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
</section>
<section id="s3-external-storage">
<span id="id60"></span><h4>S3 external storage<a class="headerlink" href="#s3-external-storage" title="Permalink to this headline"></a></h4>
<p>Before using an ObjectStorage, a dedicated Zextras bucket must be
created.</p>
<p>While similar in concept, Zextras Backup and Zextras Powerstore buckets
are not compatible with each other. If Powerstore data is stored in a
bucket it is not possible to store Backup data on the same bucket and
vice-versa.</p>
<p>The <a class="reference external" href="./cli.xml#core_listBuckets">zxsuite core listBuckets all</a>
command reports the bucket usage, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bucketName</span>                                                  <span class="n">hsm</span>
<span class="n">protocol</span>                                                    <span class="n">HTTPS</span>
<span class="n">storeType</span>                                                   <span class="n">S3</span>
<span class="n">accessKey</span>                                                   <span class="n">xxxxx</span>
<span class="n">region</span>                                                      <span class="n">EU_WEST_1</span>
<span class="n">uuid</span>                                                        <span class="mi">58</span><span class="n">fa4ca2</span><span class="o">-</span><span class="mi">31</span><span class="n">dd</span><span class="o">-</span><span class="mi">4209</span><span class="o">-</span><span class="n">aa23</span><span class="o">-</span><span class="mi">48</span><span class="n">b33b116090</span>
<span class="n">usage</span> <span class="ow">in</span> <span class="n">powerstore</span> <span class="n">volumes</span>
                  <span class="n">server</span><span class="p">:</span> <span class="n">server1</span>                                   <span class="n">volume</span><span class="p">:</span> <span class="n">centralized</span><span class="o">-</span><span class="n">s3</span>
                  <span class="n">server</span><span class="p">:</span> <span class="n">server2</span>                                   <span class="n">volume</span><span class="p">:</span> <span class="n">centralized</span><span class="o">-</span><span class="n">s3</span>
<span class="n">usage</span> <span class="ow">in</span> <span class="n">external</span> <span class="n">backup</span>                                    <span class="n">unused</span>

<span class="n">bucketName</span>                                                  <span class="n">backup</span>
<span class="n">protocol</span>                                                    <span class="n">HTTPS</span>
<span class="n">storeType</span>                                                   <span class="n">S3</span>
<span class="n">accessKey</span>                                                   <span class="n">xxxxxxx</span>
<span class="n">region</span>                                                      <span class="n">EU_WEST_1</span>
<span class="n">destinationPath</span>                                             <span class="n">server2</span>
<span class="n">uuid</span>                                                        <span class="mi">5</span><span class="n">d32b50d</span><span class="o">-</span><span class="mi">79</span><span class="n">fc</span><span class="o">-</span><span class="mi">4591</span><span class="o">-</span><span class="mi">86</span><span class="n">da</span><span class="o">-</span><span class="mi">35</span><span class="n">bedca95de7</span>
<span class="n">usage</span> <span class="ow">in</span> <span class="n">powerstore</span> <span class="n">volumes</span>                                 <span class="n">unused</span>
<span class="n">usage</span> <span class="ow">in</span> <span class="n">external</span> <span class="n">backup</span>
                  <span class="n">server</span><span class="p">:</span> <span class="n">server2</span>
</pre></div>
</div>
<p>Since each Zextras Bucket is identified by a prefix, you can use the
combination of S3 bucket credentials and Zextras bucket prefix to
uniquely identify and store multiple Zextras Buckets within a single S3
Bucket.</p>
<p>In other words, the same <em>Amazon S3 Bucket</em>, you could define several
Zextras Buckets, to be used both for Powerstore HSM and Backup</p>
</section>
<section id="s3-backup-in-a-multi-mailbox-environment">
<span id="id61"></span><h4>S3 Backup in a multi-mailbox environment<a class="headerlink" href="#s3-backup-in-a-multi-mailbox-environment" title="Permalink to this headline"></a></h4>
<p>In multi-mailbox environments, it is not necessary to create multiple
buckets: You only enter the bucket configuration information when
enabling the remote backup on the first server. The
<code class="docutils literal notranslate"><span class="pre">bucket_configuration_id</span></code> and <code class="docutils literal notranslate"><span class="pre">prefix</span></code> parameters can then be used
to store other server’s data on a separate directory on the same
storage.</p>
</section>
</section>
<section id="activate-backup-on-the-external-storage">
<span id="id62"></span><h3><a class="toc-backref" href="#id111">Activate backup on the external storage</a><a class="headerlink" href="#activate-backup-on-the-external-storage" title="Permalink to this headline"></a></h3>
<p>Once that external storage has been set up, it is necessary to let
Zextras Suite use the external storage. The procedure is slight
different, depending if the new storage needs to be accessed from a
newly installed server or if existing local backups must be migrated to
the external storage.</p>
<p>Configure on newly installed / uninitialized server</p>
<p>If there the backup has not been initialized on the server, an
Administrator can configure the external storage by running</p>
<div class="informalexample docutils container">
<p>zxsuite backup setBackupVolume S3 bucket_configuration_id VALUE
[param VALUE[,VALUE]].</p>
</div>
<p>Once the backup will be initialized, it will use the external storage.</p>
<p>Therefore, check for any missing blobs with doCheckBlobs in the Zimbra
volumes to avoid integrity errors.</p>
<p>Migrate existing backups</p>
<p>Before actually carrying out the migration, please perform the following
important maintenance task. This procedure will minimise the risk of
errors:</p>
<ol class="arabic simple">
<li><p>Double-check Zimbra permissions on the active backup path</p></li>
<li><p>Make sure that the Zextras cache folder is accessible by the Zimbra
user (typically under <code class="docutils literal notranslate"><span class="pre">/opt/zimbra/cache</span></code>)</p></li>
<li><p>Check for table errors in the myslow.log and in the MariaDb integrity
check report. If any error is found, consider running the
<code class="docutils literal notranslate"><span class="pre">mysqlcheck</span></code> command to verify the database integrity.</p></li>
<li><p>Check for any missing blobs in the Zimbra volumes with
<a class="reference external" href="./cli.xml#powerstore_doCheckBlobs">doCheckBlobs</a></p></li>
<li><p>Check for any missing digest in the backup with <a class="reference external" href="./cli.xml#backup_doSmartScan">doSmartScan
deep=true</a></p></li>
<li><p>Check for any orphaned digest or metadata in the Backup with
<a class="reference external" href="./cli.xml#backup_doCoherencyCheck">doCoherencyCheck</a></p></li>
<li><p>Optionally run a <a class="reference external" href="./cli.xml#backup_doPurge">doPurge</a> to remove
expired data from the Backup</p></li>
</ol>
<p>You can now proceed to migrate the existing backup using the appropriate
<code class="docutils literal notranslate"><span class="pre">zxsuite</span> <span class="pre">backup</span> <span class="pre">migrateBackupVolume</span></code> [[
<a class="reference external" href="./cli.xml#backup_migrateBackupVolume_Default">Default</a> |
<a class="reference external" href="./cli.xml#backup_migrateBackupVolume_Local">Local</a> |
<a class="reference external" href="./cli.xml#backup_migrateBackupVolume_S3">S3</a> ]] command.</p>
<p>Finally, once the migration has been completed you can run this final
task:</p>
<ul class="simple">
<li><p>Manually remove the old backup data. Indeed, the migration only
<strong>copies</strong> the files of the backup to the new external storage and
leaves them in the place.</p></li>
</ul>
</section>
</section>
<section id="zextras-backup-cli">
<span id="id65"></span><h2><a class="toc-backref" href="#id112">Zextras Backup CLI</a><a class="headerlink" href="#zextras-backup-cli" title="Permalink to this headline"></a></h2>
<p>This section contains the index of all <code class="docutils literal notranslate"><span class="pre">zxsuite</span> <span class="pre">backup</span></code> commands. Full
reference can be found in <a class="reference external" href="./cli.xml#zxbackup-cli-full">the dedicated
section</a>.</p>
<p><a class="reference external" href="./cli.xml#backup_doAccountScan">doAccountScan</a> |
<a class="reference external" href="./cli.xml#backup_doBackupAuthToken">doBackupAuthToken</a> |
<a class="reference external" href="./cli.xml#backup_doBackupChat">doBackupChat</a> |
<a class="reference external" href="./cli.xml#backup_doBackupCluster">doBackupCluster</a> |
<a class="reference external" href="./cli.xml#backup_doBackupLDAP">doBackupLDAP</a> |
<a class="reference external" href="./cli.xml#backup_doBackupServerCustomizations">doBackupServerCustomizations</a>
| <a class="reference external" href="./cli.xml#backup_doCheckShares">doCheckShares</a> |
<a class="reference external" href="./cli.xml#backup_doCoherencyCheck">doCoherencyCheck</a> |
<a class="reference external" href="./cli.xml#backup_doEnableDisableCOS">doEnableDisableCOS</a> |
<a class="reference external" href="./cli.xml#backup_doExport">doExport</a> |
<a class="reference external" href="./cli.xml#backup_doExternalRestore">doExternalRestore</a> |
<a class="reference external" href="./cli.xml#backup_doFixShares">doFixShares</a> |
<a class="reference external" href="./cli.xml#backup_doItemRestore">doItemRestore</a> |
<a class="reference external" href="./cli.xml#backup_doItemSearch">doItemSearch</a> |
<a class="reference external" href="./cli.xml#backup_doPurge">doPurge</a> |
<a class="reference external" href="./cli.xml#backup_doRawRestore">doRawRestore</a> |
<a class="reference external" href="./cli.xml#backup_doRestartService">doRestartService</a> |
<a class="reference external" href="./cli.xml#backup_doRestoreBlobs">doRestoreBlobs</a> |
<a class="reference external" href="./cli.xml#backup_doRestoreChat">doRestoreChat</a> |
<a class="reference external" href="./cli.xml#backup_doRestoreOnNewAccount">doRestoreOnNewAccount</a> |
<a class="reference external" href="./cli.xml#backup_doSmartScan">doSmartScan</a> |
<a class="reference external" href="./cli.xml#backup_doStartService">doStartService</a> |
<a class="reference external" href="./cli.xml#backup_doStopAllOperations">doStopAllOperations</a> |
<a class="reference external" href="./cli.xml#backup_doStopOperation">doStopOperation</a> |
<a class="reference external" href="./cli.xml#backup_doStopService">doStopService</a> |
<a class="reference external" href="./cli.xml#backup_doUndelete">doUndelete</a> |
<a class="reference external" href="./cli.xml#backup_getAccountInfo">getAccountInfo</a> |
<a class="reference external" href="./cli.xml#backup_getAllOperations">getAllOperations</a> |
<a class="reference external" href="./cli.xml#backup_getAvailableAccounts">getAvailableAccounts</a> |
<a class="reference external" href="./cli.xml#backup_getAvailableDomains">getAvailableDomains</a> |
<a class="reference external" href="./cli.xml#backup_getBackupInfo">getBackupInfo</a> |
<a class="reference external" href="./cli.xml#backup_getCOSBackupStatus">getCOSBackupStatus</a> |
<a class="reference external" href="./cli.xml#backup_getItem">getItem</a> |
<a class="reference external" href="./cli.xml#backup_getMap">getMap</a> |
<a class="reference external" href="./cli.xml#backup_getProperty">getProperty</a> |
<a class="reference external" href="./cli.xml#backup_getServerConfig">getServerConfig</a> |
<a class="reference external" href="./cli.xml#backup_getServices">getServices</a> | <a class="reference external" href="./cli.xml#backup_migrateBackupVolume_Default">migrateBackupVolume
Default</a> |
<a class="reference external" href="./cli.xml#backup_migrateBackupVolume_Local">migrateBackupVolume
Local</a> |
<a class="reference external" href="./cli.xml#backup_migrateBackupVolume_S3">migrateBackupVolume S3</a> |
<a class="reference external" href="./cli.xml#backup_monitor">monitor</a> | <a class="reference external" href="./cli.xml#backup_retrieveMetadataFromArchive_Local">retrieveMetadataFromArchive
Local</a> |
<a class="reference external" href="./cli.xml#backup_retrieveMetadataFromArchive_S3">retrieveMetadataFromArchive
S3</a> |
<a class="reference external" href="./cli.xml#backup_setBackupVolume_Default">setBackupVolume Default</a>
| <a class="reference external" href="./cli.xml#backup_setBackupVolume_Local">setBackupVolume Local</a> |
<a class="reference external" href="./cli.xml#backup_setBackupVolume_S3">setBackupVolume S3</a> |
<a class="reference external" href="./cli.xml#backup_setProperty">setProperty</a> | <a class="reference external" href="./cli.xml#backup_updateBackupVolume_S3">updateBackupVolume
S3</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Zextras Suite Installation Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mobile.html" class="btn btn-neutral float-right" title="Zextras Mobile" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, The Zextras Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>